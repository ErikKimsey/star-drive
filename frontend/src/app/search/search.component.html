<div
  id="hero"
  class="gradient-overlay container with-escaping-tiles"
>
  <div class="hero-content">
    <h1>Find Autism Support</h1>
  </div>
  <div
    class="row escaping-tiles-1x"
    fxLayout="row"
    fxLayoutGap="40px"
    fxLayoutAlign="center auto"
    id="TopOfSearch"
  >
    <app-border-box-tile
      *ngFor="let type of resourceTypes"
      fxFlex.gt-sm="calc(33% - 160px)"
      fxFlex.sm="calc(50% - 120px)"
      [iconSize]="2"
      [iconType]="type.name"
      [title]="type.label"
      [linkSize]="1"
      [isSelected]="query && query.types && query.types.includes(type.name)"
      (click)="selectType(type.name)"
    ></app-border-box-tile>
  </div>
</div>

<div class="container">
  <div class="row margin-bottom-none">
    <h1 *ngIf="query && (query.types.length === 1)" fragment="filter-top">
      <span *ngFor="let hitType of query.getHitTypes()">{{hitType.label}}</span>
    </h1>
    <h1 *ngIf="query && query.types.length >  1" fragment="filter-top">
      All Resources
    </h1>
    <app-resource-add-button [currentUser]="currentUser"></app-resource-add-button>
    <div fxLayout="row" fxLayoutGap="80px" fxLayoutAlign="space-evenly start">
      <div
        fxFlex="calc(30% - 160px)"
        class="filters"
        fxLayout="column"
        fxLayoutGap="40px"
      >
        <div class="sort-order">
          <h2>Sort by</h2>
          <mat-radio-group
            *ngIf="selectedSort && selectedSort.name"
            [(ngModel)]="selectedSort.name"
            fxLayout="column"
          >
            <ng-container *ngFor="let s of sortMethods">
              <mat-radio-button
                *ngIf="isSortVisible(s)"
                (click)="noLocation ? openLocationDialog() : sortBy(s.name)"
                [value]="s.name"
                [disabled]="isSortDisabled(s)"
              >
                {{s.label}}
                <ng-container *ngIf="(s.name === 'Relevance' && query.words != '')">
                  to "{{query.words}}"
                </ng-container>
                <ng-container *ngIf="(s.name === 'Distance')">
                  <ng-container *ngIf="isZipCode(storedZip)">({{storedZip}})</ng-container>
                  <ng-container *ngIf="gpsEnabled && !isZipCode(storedZip)">(using GPS)</ng-container>
                  <button mat-button (click)="openLocationDialog()" matTooltip="Set your location">
                    <mat-icon>location_searching</mat-icon>
                    <ng-container *ngIf="!gpsEnabled && !isZipCode(storedZip)">Set location</ng-container>
                  </button>
                </ng-container>
                <button *ngIf="(s.name !== 'Distance')" mat-button class="ghost"><mat-icon>code</mat-icon></button>
              </mat-radio-button>
            </ng-container>
          </mat-radio-group>
        </div>

        <div class="filters-topics">
          <h2>Narrow your results</h2>
          <h3 class="mat-subheader">By Age</h3>
          <div *ngIf="!query"><mat-spinner></mat-spinner></div>
          <div *ngIf="query">
            <div *ngIf="query && !query.hasAgeCounts()">No age restrictions available for these search results.</div>
            <app-search-filter [aggregations]="query.age_counts"
                               [label_map]="ageLabels"
                               (filterSelected)="selectAgeRange($event)">
            </app-search-filter>
          </div>
          <h3 class="mat-subheader">By Type</h3>
          <div *ngIf="!query"><mat-spinner></mat-spinner></div>
          <app-search-filter *ngIf="query"
                             [aggregations]="query.type_counts"
                             [label_map]="typeLabels"
                             (filterSelected)="selectType($event)">
          </app-search-filter>
          <h3 class="mat-subheader">By Topic</h3>
          <div *ngIf="!query"><mat-spinner></mat-spinner></div>
          <app-search-topics *ngIf="query" [category]="query.category" (catagorySelected)="selectCategory($event)"></app-search-topics>
        </div>
      </div>

      <div
        fxFlex="calc(70% - 160px)"
        fxLayout="column"
        fxLayoutAlign="start start"
      >
        <div *ngIf="showBreadcrumbs()" class="breadcrumbs-container">
          <mat-chip-list class="applied-filters">

            <ng-container *ngIf="query && query.words">
              <mat-chip
                (click)="removeWords()"
                class="applied-filter applied-filter-keyword"
              >
                <span class="applied-filter-label">"{{query.words}}"</span>
                <mat-icon>close</mat-icon>
              </mat-chip>
            </ng-container>

            <ng-container *ngFor="let age of query.ages let i = index">
                <mat-chip
                  (click)="selectAgeRange()"
                  class="applied-filter applied-filter-age"
                >
                  <span class="applied-filter-label">{{ageLabels[age]}}</span>
                  <mat-icon>close</mat-icon>
                </mat-chip>
            </ng-container>

            <div *ngIf="query.types.length === 1">
              <mat-chip
                (click)="selectType()"
                class="applied-filter applied-filter-age">
                <span class="applied-filter-label">{{typeLabels[query.types[0]]}}</span>
                <mat-icon>close</mat-icon>
              </mat-chip>
            </div>

            <ng-container *ngIf="query && query.category && query.category.id">
              <mat-chip
                (click)="removeCategory()"
                class="applied-filter applied-filter-topic"
              >
                <div class="applied-filter-label" fxLayout="row" fxLayoutAlign="center center">
                  <ng-container *ngIf="query.category.parent && query.category.parent.parent">
                    {{query.category.parent.parent.name}}
                    <mat-icon>chevron_right</mat-icon>
                  </ng-container>
                  <ng-container *ngIf="query.category.parent">
                    {{query.category.parent.name}}
                    <mat-icon>chevron_right</mat-icon>
                  </ng-container>
                  {{query.category.name}}
                </div>
                <mat-icon>close</mat-icon>
              </mat-chip>
            </ng-container>

          </mat-chip-list>
          <p [ngClass]="{'num-results': true, 'ghost': (!query || (query.total === 0))}">Page {{paginatorElement.pageIndex + 1}} of {{query.total}} results</p>
        </div>
        <agm-map
          *ngIf="showMap()"
          [latitude]="mapLoc ? mapLoc.lat : defaultLoc.lat"
          [longitude]="mapLoc ? mapLoc.lng : defaultLoc.lng"
          [streetViewControl]="false"
          mapTypeId="roadmap"
          [zoom]="7"
          (mapReady)="mapLoad($event)"
        >
          <agm-marker
            *ngIf="mapLoc"
            [latitude]="mapLoc.lat"
            [longitude]="mapLoc.lng"
            iconUrl="/assets/map/your-location.svg"
          ></agm-marker>
          <agm-marker-cluster imagePath="/assets/map/m">
            <ng-container *ngFor="let hit of getMapResults()">
              <agm-marker
                *ngIf="hit.hasCoords()"
                [latitude]="hit.latitude"
                [longitude]="hit.longitude"
              >
                <agm-info-window>
                  <h4>{{hit.title}}</h4>
                  <p>{{hit.description}}</p>
                  <a
                    class="chevron-link"
                    [routerLink]="['/' + hit.type.toLowerCase() + '/' + hit.id]"
                    routerLinkActive="router-link-active"
                  >{{hit.type}} Details - {{hit.milesFrom(mapLoc || defaultLoc)}}mi</a>
                </agm-info-window>
              </agm-marker>
            </ng-container>
          </agm-marker-cluster>
        </agm-map>
        <div class="row search-results margin-top-none">
          <div
            id="results"
            fxLayout="column"
            fxLayoutGap="40px"
          >
            <div *ngIf="!query"><mat-spinner></mat-spinner></div>
              <div *ngIf="query && query.hits.length === 0" fxLayout="column" fxLayoutGap="20px" fxLayoutAlign="center center" class="pad-4">
                <h2>No results currently available.</h2>
                <p>We could not find any results for your search.  Please try removing some of the conditions
                by clicking on the 'x' in the tiles above.  This will broaden the search and give you more results.</p>
                <h3>Check back soon for more updates!</h3>
              </div>
            <div *ngIf="query && query.hits.length > 0">
              <app-search-result
                *ngFor="let hit of query.hits"
                [hit]="hit"
                [mapLoc]="mapLoc"
              >
              </app-search-result>
            </div>
          </div>
      </div>
    </div>
  </div>
</div>
<div class="container">
  <div class="row margin-top-none">
    <mat-paginator
      #paginator
      [length]="query ? query.total : 0"
      [pageSize]="pageSize"
      [pageSizeOptions]="[pageSize, pageSize*3, pageSize*5]"
      (page)="updatePage($event)"
      [ngClass]="{'ghost': (!query || (query.total === 0))}"
    >
    </mat-paginator>

    <h1>Resource partners</h1>
    <p class="pad-0 margin-bottom-none">We are partnering with the following initiatives and organizations to identify resources that will improve
      outcomes for individuals with autism and their families.</p>
    <div fxLayout="row" fxLayoutAlign="space-between">
      <a
        *ngFor="let rg of resourceGatherers"
        [href]="rg.url"
        [title]="rg.name"
        [matTooltip]="rg.shortName + ' - ' + rg.description"
        class="resource-gatherer"
      >
        <img
          [alt]="rg.shortName"
          [src]="rg.image"
        >
      </a>
    </div>
  </div>
</div>



